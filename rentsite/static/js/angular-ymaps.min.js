angular.module("ymaps",[]).factory("$script",["$q","$rootScope",function(a,b){"use strict";function c(a,b){var c=document.createElement("script");c.onload=c.onreadystatechange=function(){c.readyState&&"complete"!==c.readyState&&"loaded"!==c.readyState||(c.onload=c.onreadystatechange=null,angular.isFunction(b)&&b())},c.async=!0,c.src=a,document.getElementsByTagName("body")[0].appendChild(c)}var d=[],e={};return function(f){var g=a.defer();if(-1!==d.indexOf(f))g.resolve();else{if(e[f])return e[f];c(f,function(){delete e[f],d.push(f),b.$apply(function(){g.resolve()})}),e[f]=g.promise}return g.promise}}]).factory("ymapsLoader",["$window","$timeout","$script","ymapsConfig",function(a,b,c,d){"use strict";var e;return{ready:function(f){e||(e=c(d.apiUrl).then(function(){return a.ymaps})),e.then(function(a){a.ready(function(){b(function(){f(a)})})})}}}]).constant("ymapsConfig",{apiUrl:"//api-maps.yandex.ru/2.1/?load=package.standard,package.clusters&mode=release&lang=ru-RU&ns=ymaps",mapBehaviors:["default"],markerOptions:{preset:"islands#darkgreenIcon"},clusterOptions:{preset:"islands#darkGreenClusterIcons"},fitMarkers:!0,fitMarkersZoomMargin:40,clusterize:!1}).value("debounce",function(a,b){"use strict";var c=null;return function(){var d=this,e=arguments,f=function(){c=null,a.apply(d,e)};clearTimeout(c),c=setTimeout(f,b)}}).controller("YmapController",["$scope","$element","ymapsLoader","ymapsConfig","debounce",function(a,b,c,d,e){"use strict";function f(b,c,f){c.events.add("boundschange",e(function(){if(c.getLength()>0){var e=b.options.get("maxZoom");b.options.set("maxZoom",a.zoom),b.setBounds(c.getBounds(),{checkZoomRange:!0,zoomMargin:d.fitMarkersZoomMargin}).then(function(){b.options.set("maxZoom",e),b.setZoom(b.getZoom())})}},100))}var g=this;c.ready(function(c){g.addMarker=function(b,d,e){var f=new c.Placemark(b,d,e);return a.markers.add(f),f},g.removeMarker=function(b){a.markers.remove(b)},g.map=new c.Map(b[0],{center:a.center||[0,0],zoom:a.zoom||0,behaviors:d.mapBehaviors});var e=new c.GeoObjectCollection({},d.markerOptions);d.clusterize?(a.markers=new c.Clusterer(d.clusterOptions),e.add(a.markers)):a.markers=e,g.map.geoObjects.add(e),d.fitMarkers&&f(g.map,e,c);var h,i;a.$watch("center",function(a){h||(i=!0,g.map.panTo(a).always(function(){i=!1}))},!0),a.$watch("zoom",function(a){h||g.map.setZoom(a,{checkZoomRange:!0})}),g.map.events.add("boundschange",function(b){i||(h=!0,a.$apply(function(){a.center=b.get("newCenter"),a.zoom=b.get("newZoom")}),h=!1)})})}]).directive("yandexMap",["ymapsLoader",function(a){"use strict";return{restrict:"EA",terminal:!0,transclude:!0,scope:{center:"=",zoom:"="},link:function(b,c,d,e,f){a.ready(function(){f(function(a){c.append(a)})})},controller:"YmapController"}}]).directive("ymapMarker",function(){"use strict";return{restrict:"EA",require:"^yandexMap",scope:{coordinates:"=",index:"=",properties:"=",options:"="},link:function(a,b,c,d){function e(){var b=[parseFloat(a.coordinates[0]),parseFloat(a.coordinates[1])];f&&d.removeMarker(f),f=d.addMarker(b,angular.extend({iconContent:a.index},a.properties),a.options)}var f;a.$watch("index",function(a){f&&f.properties.set("iconContent",a)}),a.$watch("coordinates",function(a){a&&e()},!0),a.$on("$destroy",function(){f&&d.removeMarker(f)})}}});